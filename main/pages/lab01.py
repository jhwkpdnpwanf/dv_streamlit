import os
import pandas as pd
import sys
import streamlit as st

BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
if BASE_DIR not in sys.path:
    sys.path.append(BASE_DIR)

from modules.lab01.lab01_utils import (
    draw_cctv_police_chart,
    plot_corr_heatmap,
    plot_top10_violence_per_100k,
)

merged_df = pd.read_csv("./data/lab01_cctv.csv")

st.title("자치구별 범죄·치안 지표 분석")

# -----------------------------
# 1) CCTV vs 경찰관서 수
# -----------------------------
st.subheader("1. 자치구별 CCTV 설치량과 경찰관서 수")  
st.markdown("""
서울 각 자치구의 CCTV 설치량과 경찰관서 수의 분포를 비교합니다.  
일반적으로 CCTV가 많은 지역일수록 인구 밀도와 상업지 밀집도가 높은 경향이 있으며,  
경찰관서 수는 범죄 발생량·행정구 면적에 따라 차이가 발생합니다.            
""")

fig1 = draw_cctv_police_chart(merged_df)
st.pyplot(fig1)

st.markdown("""
**해석**
1. CCTV 설치량이 많은 상위 구는 대부분 상업,주거 밀도가 높은 지역입니다.  
2. 경찰관서 수는 CCTV 규모와 완전히 비례하지 않습니다. 
3. CCTV는 사후 추적 중심 장비이고 경찰관서는 실제 대응 자원이므로,  
   두 지표 간 단순 비례 관계가 나타나지 않는 것으로 예측할 수 있습니다.
""")

# -----------------------------
# 2) 상관관계 히트맵
# -----------------------------
st.subheader("2. 주요 범죄·인구·치안 지표 간 상관관계")  
st.markdown("""
상관계수 히트맵을 통해, 인구 규모·CCTV·경찰관서·범죄 발생·검거율 간의  
관계를 직관적으로 확인합니다.  
양의 상관관계는 함께 증가하는 경향, 음의 상관관계는 반대 방향의 관계를 의미합니다.
""")

fig2 = plot_corr_heatmap(merged_df)
st.pyplot(fig2)

st.markdown("""
**해석**
1. **범죄발생 - 인구수**  
   인구가 많은 지역은 사건 수 자체도 커지는 경향이 있습니다.  
2. **검거율 - CCTV, 경찰관서 수**  
   CCTV, 경찰관서와 검거율이 직접 비례하지 않는 경우가 많습니다.  
   이는 검거율이 현장 상황, 사건 성격 등에 더 큰 영향을 받기 때문으로 예측할 수 있습니다.  
3. **범죄발생 - CCTV**  
   CCTV가 많은 지역은 보안 강화 목적(인구밀집지)이므로  
   범죄가 높아서 설치한 건지, 설치때문에 억제되는지 명확히 구분하기 어렵습니다.  
""")

# ------------------------------------
# 3) 인구 10만명당 폭력범죄 발생 Top 10
# ------------------------------------
st.subheader("3. 인구 10만명당 폭력범죄 발생 상위 10개 구")  
st.markdown("""
단순 범죄 건수는 인구가 많은 지역이 유리하므로,  
인구 10만 명당 폭력범죄 발생 건수로 정규화하여 위험도를 비교합니다.  
이는 인구 규모 차이를 제거한, 지역 간 실질적인 상대 위험도를 나타냅니다.
""")

fig3 = plot_top10_violence_per_100k(merged_df)
st.pyplot(fig3)

st.markdown("""
**해석**
1. 특정 구는 절대 인구는 적지만, 인구 대비 폭력범죄 비중이 높게 나타날 수 있습니다.  
2. 반대로, 인구가 매우 많은 구라도 인구 대비 비율은 낮을 수 있습니다.  
3. 폭력범죄는 주거환경,상권 밀도, 유동인구, 야간 인구 등이 결합하여 발생하므로,  
   단순한 인구 규모와 완전한 비례 관계를 가지지 않습니다.  
""")


# -----------------------------
# 4) 종합 결론
# -----------------------------
st.subheader("4. 종합 결론")

st.markdown("""
세 가지 시각화 결과를 종합적으로 보면, 서울시 자치구별 치안 지표는 단순히 장비 개수나 시설 수만으로 설명되기 어렵습니다.
각 지역의 인구 구조, 유동 인구 규모, 상업 지역 밀집도, 행정구 특성 등이 함께 작용하고 있다는 점을 확인할 수 있습니다.
첫 번째 분석에서는 자치구별 CCTV 설치 대수와 경찰관서 수가 서로 비례하지 않는 양상이 뚜렷하게 나타났습니다.
예를 들어, 강남구는 유동 인구와 상업·주거 기능이 매우 밀집된 지역이라 범죄 예방 목적의 CCTV가 집중적으로 설치된 반면,
경찰관서 수는 행정구역 단위나 조직 구조와 같은 제약 때문에 쉽게 늘어나기 어렵습니다.
반대로 종로구는 면적은 작지만 정부청사나 주요 공공기관이 밀집해 있어, 상대적으로 경찰관서가 더 많이 배치된 사례로 이해할 수 있습니다.
이를 통해 장비와 인력이 동일한 기준으로 배치되는 것은 아니라는 점을 알 수 있습니다.

두 번째 상관관계 분석에서는 인구수, 범죄 발생 건수, CCTV 설치 대수 사이에는 전반적으로 양의 상관관계가 관찰되었습니다.
하지만 검거율은 인구수나 CCTV 설치 대수와는 오히려 음의 상관관계를 보이고, 경찰관서 수와는 양의 상관관계를 보였습니다.
이는 인구가 많거나 CCTV가 많이 설치된 지역이 반드시 검거율이 높은 것은 아니라는 점을 보여줍니다.
CCTV는 사건 발생 이후 증거 확보에는 도움이 되지만, 즉각적인 출동과 체포로 이어지는 데에는 한계가 있습니다.
반면 경찰관서 수가 많다는 것은 치안 인력이 보다 촘촘하게 분포해 주민과 가까운 거리에서 대응할 수 있다는 의미이므로,
실제 검거율에는 인력과 조직 배치가 더 직접적인 영향을 미친다고 해석할 수 있습니다.
즉, 감시 기능은 CCTV가 담당하고, 실제 대응과 검거의 핵심은 경찰관서와 치안 인력이라는 역할 분담 구조가 드러납니다.

마지막으로 인구 대비 폭력 발생률을 분석한 결과, 중구, 종로구, 강남구가 상대적으로 높은 값을 보였습니다.
중구와 종로구는 상주 인구 규모에 비해 유동 인구가 매우 많은 지역이기 때문에,
단위 인구로 환산했을 때 폭력 사건 비율이 높게 나타나는 경향이 있습니다.
강남구는 유흥업소, 음식점, 유흥, 상업 시설이 밀집해 야간 활동 인구가 많은 지역이므로,
폭력 사건이 발생할 가능성이 구조적으로 높은 환경이라고 볼 수 있습니다.

종합적으로 보면, 서울시의 치안 상황을 평가할 때는 CCTV 개수나 경찰관서 수 같은 단일 지표만으로 판단하기보다는
지역별 인구 특성, 유동 인구, 상권 구조, 주요 시설 분포 등 현실적인 요인을 함께 고려해야 합니다.
향후 범죄 발생을 줄이기 위한 정책 또한 단순히 CCTV나 경찰관서를 일괄적으로 늘리는 방식보다는,
지역별 특성을 반영하여 CCTV와 경찰 인력을 재배치하는 방향이 더 효과적인 전략이라고 결론 내릴 수 있습니다.
""")

